# NixOS Introspection and Replication Workflow

This guide demonstrates the complete workflow for using operation-dbus to introspect a running system and generate a replicable NixOS configuration.

## ðŸŽ¯ Overview

The workflow consists of three main phases:

1. **Introspection** - Scan a running system to discover its state
2. **Configuration** - Generate and customize a NixOS configuration
3. **Replication** - Deploy the configuration to create an identical system

## ðŸ“‹ Prerequisites

- A running system (can be any Linux distribution)
- Root access for comprehensive introspection
- Nix package manager installed
- Target system running NixOS (for replication)

## Phase 1: System Introspection

### Step 1: Install the Introspection Tool

```bash
# Option A: Run directly from flake (no installation)
nix run github:repr0bated/operation-dbus#nix-introspect -- --help

# Option B: Install to your profile
nix profile install github:repr0bated/operation-dbus#nix-introspect

# Option C: Build from source
git clone https://github.com/repr0bated/operation-dbus
cd operation-dbus
nix build .#nix-introspect
./result/bin/nix-introspect --help
```

### Step 2: Scan Your System

```bash
# Full system scan (requires root for complete access)
sudo nix-introspect scan \
  --output /tmp/system-config.nix \
  --format nix \
  --include-mcp \
  --system-bus \
  --session-bus \
  --include-network \
  --include-systemd \
  --include-containers

# This will generate a NixOS configuration file at /tmp/system-config.nix
```

**What gets scanned:**

- âœ… All D-Bus services (system and session buses)
- âœ… Systemd units and their states
- âœ… Network interfaces and IP configurations
- âœ… OVS bridges and ports (if present)
- âœ… LXC containers (if present)
- âœ… Running services and their dependencies
- âœ… MCP agents and capabilities

### Step 3: Export as Multiple Formats

You can export the discovered state in different formats:

```bash
# NixOS configuration (for deployment)
sudo nix-introspect scan --output config.nix --format nix

# JSON (for programmatic processing)
sudo nix-introspect scan --output state.json --format json

# TOML (for configuration management)
sudo nix-introspect scan --output state.toml --format toml
```

### Step 4: Inspect Specific Services

For detailed inspection of specific D-Bus services:

```bash
# List all available services
nix-introspect list-services --bus both

# Introspect systemd
nix-introspect inspect org.freedesktop.systemd1 \
  --path /org/freedesktop/systemd1 \
  --bus system \
  --format json > systemd-introspection.json

# Introspect NetworkManager
nix-introspect inspect org.freedesktop.NetworkManager \
  --bus system \
  --format xml > networkmanager-introspection.xml
```

## Phase 2: Configuration Customization

### Step 1: Review Generated Configuration

```bash
# View the generated configuration
cat /tmp/system-config.nix

# Example output:
# =====================================================
# Generated by nix-introspect
# Hostname: my-server
# Kernel: 6.1.0-13-amd64
# Generated at: 2024-11-06T12:34:56-05:00
#
# { config, pkgs, lib, ... }:
#
# {
#   imports = [
#     ./hardware-configuration.nix
#   ];
#
#   networking.hostName = "my-server";
#
#   # Operation D-Bus Configuration
#   services.operation-dbus = {
#     enable = true;
#     plugins = {
#       systemd.enable = true;
#       network.enable = true;
#       ...
#     };
#   };
#   ...
# }
```

### Step 2: Create Your Flake Configuration

```bash
# Create a new directory for your NixOS configuration
mkdir -p ~/nixos-config
cd ~/nixos-config

# Create flake.nix
cat > flake.nix << 'EOF'
{
  description = "My NixOS Configuration with Operation D-Bus";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    operation-dbus.url = "github:repr0bated/operation-dbus";
  };

  outputs = { self, nixpkgs, operation-dbus }: {
    nixosConfigurations.myhost = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      modules = [
        operation-dbus.nixosModules.default
        ./configuration.nix
      ];
    };
  };
}
EOF
```

### Step 3: Customize the Configuration

```bash
# Copy the generated configuration
cp /tmp/system-config.nix ~/nixos-config/configuration.nix

# Edit to customize
nano ~/nixos-config/configuration.nix
```

**Customization tips:**

```nix
{ config, pkgs, ... }:

{
  imports = [
    ./hardware-configuration.nix
  ];

  # Basic system configuration
  networking.hostName = "my-server";
  time.timeZone = "America/New_York";

  # Operation D-Bus - generated configuration
  services.operation-dbus = {
    enable = true;

    plugins = {
      # Keep auto-detected plugins
      systemd.enable = true;
      network.enable = true;

      # Add custom configuration
      systemd.config = {
        units = {
          # Override or add specific services
          "nginx.service" = {
            active_state = "active";
            enabled = true;
          };
          "postgresql.service" = {
            active_state = "active";
            enabled = true;
          };
        };
      };

      network.config = {
        interfaces = [
          {
            name = "ovsbr0";
            type = "ovs-bridge";
            ports = [ "eth0" "eth1" ];
            ipv4 = {
              enabled = true;
              dhcp = false;
              address = [
                { ip = "10.0.0.1"; prefix = 24; }
              ];
            };
          }
        ];
      };

      # Enable container management
      lxc = {
        enable = true;
        config = {
          containers = [
            {
              name = "app-server";
              state = "running";
              config = {
                image = "ubuntu/22.04";
                network = {
                  type = "veth";
                  bridge = "ovsbr0";
                };
              };
            }
          ];
        };
      };
    };

    # Enable blockchain audit trail
    blockchain.enable = true;

    # Configure caching
    cache = {
      enable = true;
      maxSize = "20G";
    };

    logLevel = "info";
  };

  # MCP configuration
  services.operation-dbus.mcp = {
    enable = true;

    # Enable all agents
    agents = [
      "executor"
      "systemd"
      "file"
      "network"
      "monitor"
    ];

    # Enable web interface for remote access
    enableWebBridge = true;
    serverPort = 3000;

    # Enable D-Bus discovery
    enableDiscovery = true;

    # Enable orchestrator
    orchestrator = {
      enable = true;
      maxConcurrentTasks = 20;
    };

    # Optional: Enable chat interface
    chat = {
      enable = true;
      port = 8080;
    };
  };

  # Open firewall ports
  networking.firewall.allowedTCPPorts = [ 3000 8080 ];

  # Additional packages
  environment.systemPackages = with pkgs; [
    vim
    git
    htop
    tcpdump
  ];

  # System state version
  system.stateVersion = "24.05";
}
```

## Phase 3: System Replication

### Step 1: Deploy to Target System

#### Option A: Fresh NixOS Installation

```bash
# 1. Install NixOS with minimal configuration

# 2. Copy your configuration to the target
scp -r ~/nixos-config root@target:/etc/nixos/

# 3. On the target system
ssh root@target
cd /etc/nixos

# 4. Initialize git (required for flakes)
git init
git add .
git commit -m "Initial configuration"

# 5. Enable flakes (if not already enabled)
mkdir -p ~/.config/nix
echo "experimental-features = nix-command flakes" > ~/.config/nix/nix.conf

# 6. Build and switch
nixos-rebuild switch --flake .#myhost

# 7. Verify services are running
systemctl status operation-dbus
systemctl status dbus-mcp-server
```

#### Option B: Update Existing NixOS System

```bash
# On your existing NixOS system
cd /etc/nixos

# Backup current configuration
cp configuration.nix configuration.nix.backup

# Copy new configuration
cp ~/nixos-config/flake.nix .
cp ~/nixos-config/configuration.nix .

# Initialize git if needed
git init
git add .
git commit -m "Add operation-dbus configuration"

# Test build first
nixos-rebuild build --flake .#myhost

# If successful, switch
sudo nixos-rebuild switch --flake .#myhost
```

### Step 2: Verify the Deployment

```bash
# Check operation-dbus service
systemctl status operation-dbus

# Check MCP server
systemctl status dbus-mcp-server

# Check MCP agents
systemctl status dbus-agent-executor
systemctl status dbus-agent-systemd
systemctl status dbus-agent-file

# View logs
journalctl -u operation-dbus -f
journalctl -u dbus-mcp-server -f

# Query system state
op-dbus query

# Verify blockchain audit trail
op-dbus blockchain list

# Check cache
op-dbus cache stats
```

### Step 3: Test the MCP Interface

```bash
# If web bridge is enabled
curl http://localhost:3000/tools | jq

# Test a tool call
curl -X POST http://localhost:3000/call \
  -H "Content-Type: application/json" \
  -d '{
    "tool": "systemd.list_units",
    "arguments": {}
  }' | jq

# Access chat interface (if enabled)
# Open browser to http://localhost:8080
```

### Step 4: Apply Declarative State

```bash
# Create a state file
cat > /tmp/desired-state.json << 'EOF'
{
  "version": 1,
  "plugins": {
    "systemd": {
      "units": {
        "nginx.service": {
          "active_state": "active",
          "enabled": true
        }
      }
    },
    "net": {
      "interfaces": [
        {
          "name": "ovsbr0",
          "type": "ovs-bridge",
          "ports": ["eth0"]
        }
      ]
    }
  }
}
EOF

# Apply the state
op-dbus apply /tmp/desired-state.json

# Verify
op-dbus verify

# Check diff
op-dbus diff /tmp/desired-state.json
```

## ðŸ”„ Continuous Synchronization

### Option 1: GitOps Workflow

```bash
# Store configuration in git
cd /etc/nixos
git remote add origin git@github.com:yourusername/nixos-config.git
git push -u origin main

# On target systems, pull and rebuild
git pull
sudo nixos-rebuild switch --flake .#myhost
```

### Option 2: Automated Updates

```nix
# Add to configuration.nix
systemd.services.auto-apply-state = {
  description = "Auto-apply operation-dbus state";
  serviceConfig = {
    Type = "oneshot";
    ExecStart = "${pkgs.operation-dbus}/bin/op-dbus apply /etc/operation-dbus/state.json";
  };
};

systemd.timers.auto-apply-state = {
  wantedBy = [ "timers.target" ];
  timerConfig = {
    OnCalendar = "hourly";
    Persistent = true;
  };
};
```

## ðŸ§ª Testing

### Test in a VM First

```bash
# Build a VM to test your configuration
nixos-rebuild build-vm --flake .#myhost

# Run the VM
./result/bin/run-myhost-vm

# Test inside the VM
# - Verify services
# - Test MCP interface
# - Check network configuration
# - Validate container setup
```

### Validation Script

```bash
#!/usr/bin/env bash
# validate-deployment.sh

echo "Validating Operation D-Bus deployment..."

# Check services
services=(
  "operation-dbus"
  "dbus-mcp-server"
  "dbus-orchestrator"
  "dbus-agent-executor"
)

for service in "${services[@]}"; do
  if systemctl is-active --quiet "$service"; then
    echo "âœ… $service is running"
  else
    echo "âŒ $service is not running"
    exit 1
  fi
done

# Check MCP web bridge
if curl -s http://localhost:3000/tools > /dev/null; then
  echo "âœ… MCP web bridge is accessible"
else
  echo "âŒ MCP web bridge is not accessible"
fi

# Query system state
if op-dbus query > /dev/null; then
  echo "âœ… op-dbus query successful"
else
  echo "âŒ op-dbus query failed"
  exit 1
fi

echo "âœ… All validation checks passed!"
```

## ðŸ“Š Monitoring

### View Logs

```bash
# Real-time logs for all operation-dbus services
journalctl -f \
  -u operation-dbus \
  -u dbus-mcp-server \
  -u dbus-orchestrator \
  -u 'dbus-agent-*'

# Filter by log level
journalctl -u operation-dbus -p info

# Export logs for analysis
journalctl -u operation-dbus --since "1 hour ago" > /tmp/opdbus-logs.txt
```

### System Metrics

```bash
# Check operation-dbus status
op-dbus doctor

# View cache statistics
op-dbus cache stats

# View blockchain
op-dbus blockchain list

# View recent state changes
op-dbus blockchain query --limit 10
```

## ðŸŽ“ Advanced Topics

### Multi-System Deployment

```bash
# Use the same configuration for multiple systems
# with host-specific overrides

# flake.nix
{
  outputs = { self, nixpkgs, operation-dbus }: {
    nixosConfigurations = {
      web-server = nixpkgs.lib.nixosSystem {
        modules = [
          operation-dbus.nixosModules.default
          ./common.nix
          ./hosts/web-server.nix
        ];
      };

      db-server = nixpkgs.lib.nixosSystem {
        modules = [
          operation-dbus.nixosModules.default
          ./common.nix
          ./hosts/db-server.nix
        ];
      };
    };
  };
}
```

### CI/CD Integration

```yaml
# .github/workflows/deploy.yml
name: Deploy NixOS Configuration

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build configuration
        run: nix build .#nixosConfigurations.myhost.config.system.build.toplevel

      - name: Deploy to production
        run: |
          nix copy --to ssh://root@production ./result
          ssh root@production nixos-rebuild switch --flake .#myhost
```

## ðŸ†˜ Troubleshooting

### Common Issues

**Service fails to start:**
```bash
# Check logs
journalctl -u operation-dbus -n 50

# Verify D-Bus connection
dbus-send --system --print-reply \
  --dest=org.freedesktop.DBus \
  /org/freedesktop/DBus \
  org.freedesktop.DBus.ListNames
```

**MCP server not accessible:**
```bash
# Check if port is open
ss -tlnp | grep 3000

# Verify firewall
sudo iptables -L -n | grep 3000

# Test locally
curl -v http://localhost:3000/tools
```

**Introspection fails:**
```bash
# Run with verbose logging
RUST_LOG=debug nix-introspect scan --output /tmp/debug-config.nix

# Check D-Bus permissions
dbus-send --system --print-reply \
  --dest=org.freedesktop.DBus \
  /org/freedesktop/DBus \
  org.freedesktop.DBus.ListNames
```

## ðŸš€ Next Steps

1. **Explore Examples**: Check the `nix/examples/` directory for more configurations
2. **Read Documentation**: See `nix/README.md` for detailed module options
3. **Join Community**: Report issues and contribute at GitHub
4. **Extend System**: Write custom plugins and MCP agents

---

**Happy replicating! ðŸŽ‰**
